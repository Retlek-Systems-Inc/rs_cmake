# @copyright 2021 Retlek Systems Inc.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

stages:
  - lint
  - build

default:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]

# Common Build Docker script
.common_build_docker: &common_build_docker
  - mkdir -p /kaniko/.docker
  - echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  - >-
    /kaniko/executor
    --context "${CI_PROJECT_DIR}"
    --dockerfile "${CI_PROJECT_DIR}/docker/${DOCKER_IMAGE}/Dockerfile"
    --destination "${CI_REGISTRY_IMAGE}/${DOCKER_IMAGE}:${CI_COMMIT_TAG}"
    --destination "${CI_REGISTRY_IMAGE}/${DOCKER_IMAGE}:latest"

lint_dockerfiles:lint:
  stage: lint
  image:
    name: hadolint/hadolint:latest-debian
  script:
    - hadolint docker/sw-dev/Dockerfile
    - hadolint docker/hw-dev/Dockerfile
    - hadolint docker/docs/Dockerfile
  only:
    refs:
      - master
      - merge_requests
    changes:
      - docker/*/Dockerfile

sw-dev:build:
  stage: build
  inherit:
    default: [image]
  variables:
    DOCKER_IMAGE: sw-dev
  script:
    - *common_build_docker
  only:
    refs:
      - tags
    changes:
      - docker/sw-dev/Dockerfile

hw-dev:build:
  stage: build
  needs: ["sw-dev:build"]
  inherit:
    default: [image]
  variables:
    DOCKER_IMAGE: hw-dev
  script:
    - *common_build_docker
  only:
    refs:
      - tags
    changes:
      - docker/*/DockerFile

docs:build:
  stage: build
  needs: ["sw-dev:build"]
  inherit:
    default: [image]
  variables:
    DOCKER_IMAGE: docs
  script:
    - *common_build_docker
  only:
    refs:
      - tags
    changes:
      - docker/*/DockerFile
