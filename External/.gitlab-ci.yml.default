# @copyright 2021 Retlek Systems Inc.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

stages:
  - build
  - test
  - analysis
# - benchmark
# - deploy

variables:
  BASE_BUILD_DIR: ci_build
  DEPS_DIR: ${BASE_BUILD_DIR}/deps

#default image - TODO(phelter): Move to pre-generated docker image.
default:
  image: registry.gitlab.com/retleksystems/env/cmake/sw-dev:v0.1.3
  before_script:
    # Subproject tools
    #    - apt -y install protobuf-compiler python-protobuf libprotobuf-dev
    # Setup git access using ssh keys
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

    # Setup git access using gitlab ci token and username
    # - git config --global credential.helper store
    # - echo "https://${RS_CI_DEPLOY_USER}:${RS_CI_DEPLOY_TOKEN}@gitlab.com" > ~/.git-credentials
    # after_script:
    # - rm ~/.git-credentials

cache: &global_cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    - ${BASE_BUILD_DIR}
  policy: pull-push

# Common Build for GCC
.common_gcc_build: &common_gcc_build
  - mkdir -p ${DEPS_DIR}
  - mkdir -p ${BUILD_DIR}
  - cmake -G Ninja -B${BUILD_DIR} -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DFETCHCONTENT_BASE_DIR=${DEPS_DIR} ${CMAKE_BUILD_ARGS} .
  - cmake --build ${BUILD_DIR} -- -k 10000

# Common Build for Clang
.common_clang_build: &common_clang_build
  - mkdir -p ${DEPS_DIR}
  - mkdir -p ${BUILD_DIR}
  - cmake -G Ninja -B${BUILD_DIR} -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DCMAKE_C_COMPILER=clang-14 -DCMAKE_CXX_COMPILER=clang++-14 -DFETCHCONTENT_BASE_DIR=${DEPS_DIR} ${CMAKE_BUILD_ARGS} .
  - cmake --build ${BUILD_DIR} -- -k 10000

# Common Run Tests
.common_run_test: &common_run_test
  - cd ${BUILD_DIR}
  - ctest --output-on-failure --output-junit report.xml

# prepare
# Use gcc-debug:build as prepare - all other builds must wait on this to ensure
# cache is built for deps and ccache.

#------------------------------------------------------------------------------
gcc-debug:build:
  stage: build
  cache:
    <<: *global_cache
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/gcc-debug
    BUILD_TYPE: Debug
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=OFF
  script:
    - *common_gcc_build

gcc-debug:test:
  stage: test
  needs: ["gcc-debug:build"]
  extends: gcc-debug:build
  cache:
    <<: *global_cache
    policy: pull
  script:
    - *common_gcc_build # cache not guaranteed
    - *common_run_test
    #- cmake --build . --target memcheck -- -k 10000 - check with valgrind TODO(phelter)
  artifacts:
    when: always
    reports:
      junit: ${BUILD_DIR}/report.xml

#------------------------------------------------------------------------------
gcc-relwithdebinfo:build:
  stage: build
  needs: ["gcc-debug:build"]
  cache:
    <<: *global_cache
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/gcc-relwithdebinfo
    BUILD_TYPE: RelWithDebInfo
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=OFF
  script:
    - *common_gcc_build

gcc-relwithdebinfo:test:
  stage: test
  needs: ["gcc-relwithdebinfo:build"]
  extends: gcc-relwithdebinfo:build
  cache:
    <<: *global_cache
    policy: pull
  script:
    - *common_gcc_build # cache not guaranteed
    - *common_run_test
    #- cmake --build . --target memcheck -- -k 10000 - check with valgrind TODO(phelter)
  artifacts:
    when: always
    reports:
      junit: ${BUILD_DIR}/report.xml

#------------------------------------------------------------------------------
clang-debug:build:
  stage: build
  needs: ["gcc-debug:build"]
  #  only: [main, merge_requests]
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/clang-debug
    BUILD_TYPE: Debug
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=ON
  script:
    - *common_clang_build

clang-debug:test:
  stage: test
  needs: ["clang-debug:build"]
  extends: clang-debug:build
  cache:
    <<: *global_cache
    policy: pull
  script:
    - *common_clang_build # cache not guaranteed
    - *common_run_test
  artifacts:
    when: always
    reports:
      junit: ${BUILD_DIR}/report.xml

#------------------------------------------------------------------------------
clang-asan:build:
  stage: build
  needs: ["gcc-debug:build"]
  #  only: [main, merge_requests]
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/clang-asan
    BUILD_TYPE: asan
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=OFF
  script:
    - *common_clang_build

clang-asan:test:
  stage: test
  needs: ["clang-asan:build"]
  extends: clang-asan:build
  cache:
    <<: *global_cache
    policy: pull
  script:
    - *common_clang_build # cache not guaranteed
    - *common_run_test
  artifacts:
    when: always
    reports:
      junit: ${BUILD_DIR}/report.xml

#------------------------------------------------------------------------------
clang-tsan:build:
  stage: build
  needs: ["gcc-debug:build"]
  #  only: [main, merge_requests]
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/clang-tsan
    BUILD_TYPE: tsan
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=OFF
  script:
    - *common_clang_build

clang-tsan:test:
  stage: test
  needs: ["clang-tsan:build"]
  extends: clang-tsan:build
  cache:
    <<: *global_cache
    policy: pull
  script:
    - *common_clang_build # cache not guaranteed
    - *common_run_test
  artifacts:
    when: always
    reports:
      junit: ${BUILD_DIR}/report.xml
# TODO:
# clang-msan
# clang-ubsan

#------------------------------------------------------------------------------
gcc-coverage:build:
  stage: build
  needs: ["gcc-debug:build"]
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/gcc-coverage
    BUILD_TYPE: coverage
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=OFF
  script:
    - *common_gcc_build

gcc-coverage:test:
  stage: test
  needs: ["gcc-coverage:build"]
  extends: gcc-coverage:build
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
    policy: pull
  script:
    - *common_gcc_build # cache not guaranteed
    - *common_run_test
    - cmake --build . --target code-coverage
  artifacts:
    when: always
    reports:
      junit: ${BUILD_DIR}/report.xml
    paths:
      - ${BUILD_DIR}/coverage

#------------------------------------------------------------------------------
# clang-format:
#   stage: analysis
#   needs: ["clang-all:prepare"]
#   #  only: [main, merge_requests]
#   inherit:
#     default: [image, before_script]
#   variables:
#     BUILD_DIR: ${BASE_BUILD_DIR}/clang-cppcheck
#   script:
#     - cmake --build . --target format

clang-cppcheck:build:
  stage: analysis
  needs: ["gcc-debug:build"]
  #  only: [main, merge_requests]
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
    policy: pull
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/clang-cppcheck
    BUILD_TYPE: Debug
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=ON -DUSE_CLANG_TIDY=OFF -DUSE_CPPCHECK=ON
  script:
    - *common_clang_build
  # TODO: Add in logging checks for cpp logs?

clang-cpplint:build:
  stage: analysis
  needs: ["gcc-debug:build"]
  #  only: [main, merge_requests]
  inherit:
    default: [image, before_script]
  cache:
    <<: *global_cache
    policy: pull
  variables:
    BUILD_DIR: ${BASE_BUILD_DIR}/clang-cpplint
    BUILD_TYPE: Debug
    CMAKE_BUILD_ARGS: -DSTATIC_ANALYSIS=ON -DUSE_CLANG_TIDY=OFF -DUSE_CPPLINT=ON
  script:
    - *common_clang_build
  # TODO: Add in logging checks for cpp logs?
#------------------------------------------------------------------------------
# document:
#   inherit:
#     default: [image, before_script]
#   stage: analysis
#   before_script:
#     - apt -y install doxygen graphviz default-jdk python3-sphinx python3-pip
#     - mkdir ~/java && wget -O ~/java/platnuml.jar http://sourceforge.net/projects/plantuml/files/plantuml.jar/download
# #    - python3 -m pip install sphinx_rtd_theme breathe
#     - doxygen --version
#     # TODO: Any other versions?
#   variables:
#     PLANTUML_DIR: ~/java
#     BUILD_DIR: ci_build/cmake.document
#   script:
#     - mkdir -p $BUILD_DIR && cd $BUILD_DIR
#     - cmake -G Ninja -DBUILD_DOC=ON ../.. | tee build.log
#     - ninja doc | tee -a build.log
#   artifacts:
#     - $BUILD_DIR/docs/html

# # TODO: Others ?

# # TODO: Need to implement cmake target
# benchmark:
#   inherit:
#     gcc-9: [image, before_script, variables]
#   before_script:
#     -apt -y install libbenchmark-dev linux-tools-generic
#   script: benchmark
#     - mkdir $BUILD_DIR && cd $BUILD_DIR
#     - cmake -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE ../..
#     - cmake --build . -- -k 10000
#     - cmake --build . --target benchmark

# deploy-ubuntu-bionic:
#   inherit:
#     default: [image, before_script]
#   stage: deploy
#   variables:
#     BUILD_DIR: ci_build/cmake.release-gcc-9.x64
#     TOOLCHAIN_FILE: ../_deps/buildenv/cmake/toolchain/gcc.toolchain.cmake
#   script:
#     - mkdir $BUILD_DIR && cd $BUILD_DIR
#     - cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE ../..
#     - cmake --build . -- -k 10000
#     - cpack -G DEB .
# #  after_script:
# #    - curl -T $BUILD_DIR/name.deb -???:${BINTRAY_API_KEY} "https://api.bintray.com/content/retleksystems/dpkg/???/0.1.0/pool/main/h/"
#   artifacts:
#     paths:
#       - build/*.deb
