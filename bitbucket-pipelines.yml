# Build docker images for development with cmake for bitbucket CI
#
# Lints, Builds and deploys the docker images for the following development environments:
#   sw-dev
#   hw-dev - todo.
#
# Prerequisites: $DOCKERHUB_USER, $DOCKERHUB_PASSWORD setup as deployment variables

image: atlassian/default-image:3

#.common_build_docker: &common_build_docker
#  - echo ${DOCKERHUB_PASSWORD} | docker login --username "${DOCKERHUB_USER}" --password-stdin
#  - DOCKER_NAME="${DOCKERHUB_USER}/${DOCKER_IMAGE}"
#  - cd docker/${DOCKER_IMAGE}
#  - docker build -t ${DOCKER_NAME}:${BITBUCKET_TAG} .
#  - docker tag ${DOCKER_NAME}:${BITBUCKET_TAG} ${DOCKER_NAME}:latest
#  - docker push ${DOCKER_NAME}

pipelines:
  default:
    - step:
        name: Lint Docker files
        image: hadolint/hadolint:latest-debian
        script:
          - hadolint docker/sw-dev/Dockerfile
          # - hadolint docker/hw-dev/Dockerfile
  tags:
    v*:
      - step:
          name: Build and Deploy sw-dev
          script:
            - DOCKER_IMAGE="sw-dev"
            - echo ${DOCKERHUB_PASSWORD} | docker login --username "${DOCKERHUB_USER}" --password-stdin
            - DOCKER_NAME="${DOCKERHUB_USER}/${DOCKER_IMAGE}"
            - cd docker/${DOCKER_IMAGE}
            - docker build -t ${DOCKER_NAME}:${BITBUCKET_TAG} .
            - docker tag ${DOCKER_NAME}:${BITBUCKET_TAG} ${DOCKER_NAME}:latest
            - docker push ${DOCKER_NAME}
          services:
            - docker
          caches:
            - docker
    # - step:
    #     name: Build and Deploy hw-dev
    #     script:
    #       - DOCKER_IMAGE="hw-dev"
    #       - echo ${DOCKERHUB_PASSWORD} | docker login --username "${DOCKERHUB_USER}" --password-stdin
    #       - DOCKER_NAME="${DOCKERHUB_USER}/${DOCKER_IMAGE}"
    #       - cd docker/${DOCKER_IMAGE}
    #       - docker build -t ${DOCKER_NAME}:${BITBUCKET_TAG} .
    #       - docker tag ${DOCKER_NAME}:${BITBUCKET_TAG} ${DOCKER_NAME}:latest
    #       - docker push ${DOCKER_NAME}
    #     services:
    #       - docker
    #     caches:
    #       - docker
